<!-- 
 * Webfit plugin for KiwiIRC - http://www.webfit.fr - 07/2014 
 * Rework by Cory Chaplin <elephantman@europnet.org>
-->
<style type="text/css">
    #kiwi .nickserv_auth .warning {
        color: #F00;
        font-weight: bold;
    }
</style>
<script>
(function () {
    // Configure the NickServ to match the for the networks
    var nickserv_nick = "NickServ";

    var nickServModalView = Backbone.View.extend({
        events: {
            'submit form': 'submitNickserv'
        },

        // Build the modal box
        render: function() {
            this.modalbox = new kiwi.components.MenuBox(this.model.locale.translate('identification').fetch());
            this.$el.html('<form class="nickserv_auth" method="POST">\
                            <div>\
                                <p>' + this.model.locale.translate('registered_nick_identify').fetch() + '</p>\
                                <p class="warning"></p> \
                                <input type="password" placeholder="Mot de passe" class="nickserv_password">\
                                <button class="nickserv_submit" class="btn btn-primary">' + this.model.locale.translate('submit').fetch() + '</button>\
                            </div>\
                        </form>');

            this.modalbox.addItem(this.model.locale.translate('identification').fetch(), this.$el);
            this.modalbox.show();

            this.$('.nickserv_password').focus();
        },

        submitNickserv: function(event) {
            event.preventDefault();

            if(this.$(".nickserv_password").val() != "") {
                this.model.trigger('identify', this.$(".nickserv_password").val()); 
            };

        }        
    });

    var nickServModal = Backbone.Model.extend({
        initialize: function () {
            var that = this;
            
            this.network = kiwi.components.Network();
            this.boxState = '';
            this.boxTriggered = false;

            var locale_strings;

            locale_strings = {
                'en': {
                    "nickserv_authbox" : {
                        "" : {
                            "domain" : "nickserv_authbox",
                            "lang" : "en"
                        },
                        "identification" : [ null, "Identification" ],
                        "registered_nick_identify" : [ null, "This nickname is registered, you must identify to use it." ],
                        "submit" : [ null, "Unknown" ],
                        "bad_password" : [ null, "Search" ]
                    }
                },
               'fr': {
                    "nickserv_authbox" : {
                        "" : {
                            "domain" : "nickserv_authbox",
                            "lang" : "fr"
                        },
                        "identification" : [ null, "Identification" ],
                        "registered_nick_identify" : [ null, "Ce pseudonyme est réservé, vous devez vous identifer pour le conserver." ],
                        "submit" : [ null, "Valider" ],
                        "bad_password" : [ null, "Mot de passe incorrect, veuillez le saisir à nouveau !" ]
                    }
                }
            }

            // Create a new JED instance
            this.locale = new Jed({
                "domain" : "nickserv_authbox",
                "missing_key_callback" : function(key) {
                    console.error(key)
                },
                "locale_data" : locale_strings[kiwi.i18n._textdomain] || locale_strings['en']
            });

            this.network.on('message', function (event) {
                that.parseMessage(event, nickserv_nick);
            });

            this.bind('identify', this.nickservIdentify);

            this.view = new nickServModalView({model: this});
        },

        parseMessage: function(event, nick) {
            // Parse NickServ notices
            if(event.type == "notice" && event.nick == nickserv_nick) {
                if(event.msg.search(/This nickname is registered/) >= 0 || 
                    event.msg.search(/Le pseudo est enregistr/)  >= 0) { // Nick is registered
                    this.boxState = 'open';
                } else if(event.msg.search(/you are now recognized/) >= 0 || 
                            event.msg.search(/tes maintenant identifi/) >= 0) { // Password correct
                    this.boxState = 'close';
                } else if(event.msg.search(/Password incorrect/) >= 0 || 
                            event.msg.search(/Mot de passe incorrect/) >= 0) { // Bad password
                    this.view.$(".nickserv_auth .warning").html(this.locale.translate('bad_password').fetch());
                    this.view.$(".nickserv_auth .warning").show();
                    this.boxState = 'open';
                } else if(event.msg.search(/Your nickname is now being changed to/) >= 0 || 
                            event.msg.search(/pseudo est maintenant chang/) >= 0) { // Nick changed
                    this.boxState = 'close';
                }

                // If not already triggered, trigger the mobal box
                if(this.boxTriggered == false) this.toggleModalBox();
            }
        },

        // This triggers the modal box toggle
        toggleModalBox: function() {
            var that = this;
            this.boxTriggered = true;

            // Wait 500ms in case other contradictory notices are coming, then toggle the modal box
            setTimeout(function() {
                that.doToggleModalBox();
            }, 500);
        },

        // This toggles the modal box
        doToggleModalBox: function() {
            if(this.boxState == 'open' && !this.view.$el.is(':visible')) {
                this.view.render(); // Create the modal
            } else if(this.boxState == 'close') {
                this.view.modalbox.dispose(); // Close the modal
            } else {
                this.boxState = ''; // Do nothing
            }

            this.boxTriggered = false;
        },

        // This sends the nickserv identify command
        nickservIdentify: function() {
            this.network.msg(nickserv_nick, 'identify ' + this.view.$(".nickserv_password").val())
        }
    });

    var triggerNickServModal = new nickServModal;
})();
</script>