<!-- Plugin Webfit pour KiwiIRC - http://www.webfit.fr - 07/2014 -->
<div id="canvas_ignore">
  <table>
    <thead style="font-weight: bold;">
      <tr>
        <td class="user_name_title"><a>Utilisateurs</a></td>
        <td class="date_title"><a>Date</a></td>
        <td class="action_title"><a>Action</a></td>
      </tr>
    </thead>
    <tbody style="vertical-align: top;" class="ignorelist_list">
    </tbody>
  </table>
</div>
<style>

#kiwi .user_name_title {width: 300px;}
#kiwi .date_title {width: 200px;}
#kiwi .action_title {width: 150px;}
#canvas_ignore td {padding: 3px;}
#kiwi .btn-xs {
	padding: 1px 5px;
	font-size: 12px;
	line-height: 1.5;
	border-radius: 3px;
}
</style>
<script>
kiwi.plugins.on('loaded', function() {
	var ignorelist_data = kiwi.components.DataStore.instance('kiwi.ignore_list');
		ignorelist_data.load();
	var ignorelist = ignorelist_data.get('ignore_list');


	var net = kiwi.components.Network();
	net.on('connect', function() {
		if(ignorelist == null) {
			return;
		}
		kiwi.connections.active_connection.set("ignore_list",ignorelist);
	});
	
	$("#kiwi .app_tools .main").prepend('<li id="ignorelist"><button class="btn btn-primary"><i class="fa fa-ban" title="Liste des ignorés"></i><span class="button-text">&nbsp;Ignorés</span></button></li>');

	(function () {
        var view = Backbone.View.extend({
            events: {
            },

            initialize: function (options) {
                var that = this;
                this.$el = $($('#canvas_ignore').html().trim());
				
                this.model.on('applet_loaded', function () {
                    that.$el.parent().css('height', '100%');
										
					that.showIgnore();
                });
            },
			
			showIgnore : function() {
				var tab = kiwi.connections.active_connection.get("ignore_list");
				
				for(var i = 0; i<tab.length;i++) {
					if($(".ignorelist_name:contains('"+tab[i]+"')").length == 0)
					$(".ignorelist_list").append('<tr><td class="ignorelist_name">'+tab[i]+'</td><td class="ignorelist_num_users">21/05/2014</td><td class="ignorelist_action"><button class="btn btn-warning btn-xs ignorelist_remove" data-nn="'+tab[i]+'">Effacer</button></td></tr>');
				}
			}			
        });



        var applet = Backbone.Model.extend({
            initialize: function () {
                var that = this;

                this.set('title', 'Liste des ignorés');
                this.view = new view({model: this});

                this.on('applet_loaded', function () {
					that.startApplet();
                });
            },


            startApplet: function() {
            }		
        });

        kiwi.components.Applet.register('canvas_ignore', applet);
    })();
	
	$(document).on("click",".applets li", function() {
		if(kiwi.panels().active.get("title") == "Liste des ignorés") {
			var tab = kiwi.connections.active_connection.get("ignore_list");

			for(var i = 0; i<tab.length;i++) {
				if($(".ignorelist_name:contains('"+tab[i]+"')").length == 0) {
					$(".ignorelist_list").append('<tr><td class="ignorelist_name">'+tab[i]+'</td><td class="ignorelist_num_users">21/05/2014</td><td class="ignorelist_action"><button class="btn btn-warning btn-xs ignorelist_remove" data-nn="'+tab[i]+'">Effacer</button></td></tr>');
				}
			}
		}
	});
	

	
	$(document).on("change",".close_menu input", function() {
		var tab = kiwi.connections.active_connection.get("ignore_list");
		ignorelist_data.set('ignore_list',tab);
		ignorelist_data.save();
	});
	
	
	
	$(document).on("click",".ignorelist_remove",function() {
		var tab = kiwi.connections.active_connection.get("ignore_list");
		var n = tab.indexOf($(this).attr("data-nn")); 
		tab.splice(n,1);
		kiwi.connections.active_connection.set("ignore_list",tab);
		ignorelist_data.set('ignore_list',tab);
		ignorelist_data.save();
		
		$(this).parent().parent().remove();
	});
	
	$(document).on("click","#ignorelist", function() {
		kiwi.components.Applet.loadOnce('canvas_ignore').view.show();		
	});
});
</script> 
