<!--
    Plugin by Cory Chaplin (elephantman@europnet.org) - http://www.europnet.org - 01/2015 
-->

<style>
    /*#kiwi .cred {
        color: #ff0000;
    }
    #kiwi .right_bar_query {
        background-color: #fff;
        border-left: 1px dashed #ccc;
        z-index: 10;
        bottom: 100px;
        overflow: visible;
        position: absolute;
        right: 0;
        top: 100px;
        width: 200px;
    }
    #kiwi .right_bar_query.disabled {
        width: 0;
    }*/
    #kiwi .right_bar .queries > div {
        display: none;
    }
    #kiwi .right_bar .queries > div.active {
        display: block;
    }
    #kiwi .right_bar .queries {
        margin: 10px;
    }
    #kiwi .right_bar .queries .query_avatar {
        text-align: center;
        width: 100%;
    }
    #kiwi .right_bar .queries .query_avatar > img {
        border: 1px solid #999;
        padding: 6px;
    }
    #kiwi .right_bar .queries .query_nick {
        font-size: 1.5em;
        font-weight: bold;
        margin: 10px 0;
        text-align: center;
    }
    #kiwi .right_bar .queries .common_channels {
        clear: both;
        margin: 10px 0;
    }
    #kiwi .right_bar .queries .common_channels .query_common_channels_title {
        font-weight: bold;
        font-size: 1.1em;
    }
    #kiwi .right_bar .queries .query_tools > button {
        margin: 2px 0;
    }
</style>

<script type="text/html" id="query_sidebar_container">
<div class="queries">
</div>
</script>
<script type="text/html" id="query_sidebar_content">
    <div class="<%= query_id %>">
        <div class="query_avatar"></div>
        <div class="query_nick">
            <span class="query_nick_nickname"></span>
        </div>
        <div class="query_infos">
            <span class="query_gender"></span><span class="query_age"></span><span class="query_location"></span>
        </div>
        <div class="common_channels">
            <span class="query_common_channels_title"><%= common_channels %></span><br />
        </div>        
        <div class="query_tools">
            <button class="query_whois"><i title="<%= whois %>" class="fa fa-search"></i>&nbsp;<%= whois %></button><br />
            <button class="query_ignore"><i title="<%= ignore %>" class="fa fa-minus-circle"></i>&nbsp;<%= ignore %></button><br />
            <i title="<%= hide_sidebar %>" class="fa fa-angle-double-right right-bar-toggle-inner"></i>
        </div>
    </div>
</script>


<script>
kiwi.plugins.on('loaded', function() {
    // This plugin is only valid for rich_nicklist contexts
    if(!kiwi.settings.get('rich_nicklist')) return;

    var locale_strings,
        text;

    locale_strings = {
        'en': {
            "query_sidebar" : {
                "" : {
                    "domain" : "query_sidebar",
                    "lang" : "en"
                },
                "whois" : [ null, "User info" ],
                "ignore" : [ null, "Ignore user" ],
                "unignore" : [ null, "Stop ignoring" ],
                "common_channels" : [ null, "Channels in common" ],
                "hide_sidebar" : [ null, "Hide" ],
                "years_old" : [ null, "years old" ],
                "gender_male" : [ null, "Male" ],
                "gender_female" : [ null, "Female" ],
                "gender_unknown" : [ null, "" ]
            }
        },
       'fr': {
            "query_sidebar" : {
                "" : {
                    "domain" : "query_sidebar",
                    "lang" : "fr"
                },
                "whois" : [ null, "Infos" ],
                "ignore" : [ null, "Bloquer" ],
                "unignore" : [ null, "Ne plus bloquer" ],
                "common_channels" : [ null, "Salons communs" ],
                "hide_sidebar" : [ null, "Masquer" ],
                "years_old" : [ null, "ans" ],
                "gender_male" : [ null, "Homme" ],
                "gender_female" : [ null, "Femme" ],
                "gender_unknown" : [ null, "" ]
            }
        }
    }

    // Create a new JED instance
    this.locale = new Jed({
        "domain" : "query_sidebar",
        "missing_key_callback" : function(key) {
            console.error('Translation key missing: ' + key)
        },
        "locale_data" : locale_strings[kiwi.i18n._textdomain] || locale_strings['en']
    });

    // Set the locale strings
    text = {
        whois: this.locale.translate('whois').fetch(),
        ignore: this.locale.translate('ignore').fetch(),
        unignore: this.locale.translate('unignore').fetch(),
        common_channels: this.locale.translate('common_channels').fetch(),
        hide_sidebar: this.locale.translate('hide_sidebar').fetch(),
        years_old: this.locale.translate('years_old').fetch(),
        gender_male: this.locale.translate('gender_male').fetch(),
        gender_female: this.locale.translate('gender_female').fetch(),
        gender_unknown: this.locale.translate('gender_unknown').fetch()
    };


    kiwi.events.on('panel:active', function(event, panel) {
        var panel = panel['active'];

        // Hide all query rightbars
        $('#kiwi .right-bar-content .queries').children().removeClass('active');        
        
        if(panel.isQuery()) {
            // If this is the first query, create "queries" right_bar container
            if($('#kiwi .right-bar-content .queries') == undefined || $('#kiwi .right-bar-content .queries').length == 0) {
                var query_sidebar_container = $(_.template($('#query_sidebar_container').html().trim(), text));
                
                $('#kiwi .right_bar .right-bar-content').append(query_sidebar_container);
            }

            // If this query doesn't exist yet, we'll create the right_bar for it
            if($('#kiwi .right-bar-content .queries .' + panel.cid).length == 0) {
                text['query_id'] = panel.cid;

                // Push the html with the locale strings
                var query_sidebar_content = $(_.template($('#query_sidebar_content').html().trim(), text));
                var query_nick = panel.get('name'),
                    current_panel = panel.cid,
                    common_channels = [],
                    query_gender = '',
                    query_age = '',
                    query_location = '',
                    avatar = '',
                    gender_text = '';

                // Add the right_bar content
                $('#kiwi .right-bar-content .queries').append(query_sidebar_content);
                $('#kiwi .right_bar .queries .' + panel.cid + ' .query_nick .query_nick_nickname').text(query_nick);
                // Make the right_bar for this query visible
                $('#kiwi .right-bar-content .queries .' + panel.cid).addClass('active');

                // Update the ignore status if query_nick is already ignored
                if(getIgnoreStatus(query_nick) > -1) {
                    $('#kiwi .right_bar .queries .' + panel.cid + ' .query_ignore').html('<i title="' + text.unignore + '" class="fa fa-minus-circle"></i>&nbsp;' + text.unignore);
                }

                // Run through all the open channels to find the ones in common with the current query user
                _.each(kiwi.connections.panels(), function(panel) {
                    if(panel.get('members') != undefined) {
                        var members = panel.get('members').nick_cache,
                            panel_name = panel.get('name');

                        // Check if the member is in the channel
                        for(member in members) {
                            var regexp = new RegExp(query_nick, 'i');
                            if(member.match(regexp)) {
                                var clean_panel_name = panel_name.replace('#', '');
                                common_channels.push('<a class="chan ' + clean_panel_name + '" data-channel="' + panel_name + '">' + _.escape(panel_name) + '</a>');

                                /*$('#kiwi .right_bar .queries .' + current_panel + ' .common_channels a.' + clean_panel_name).click(function() {
                                    console.log('ok');
                                        kiwi.connections.active_connection.createAndJoinChannels(panel_name);
                                        kiwi.connections.active_connection.panels.getByName(panel_name).show();
                                });*/

                                // Find ASL from the member we're opening a query with 
                                if(query_gender == '') {
                                    var query_member = members[member];

                                    query_gender = query_member.get('gender');
                                    query_age = query_member.get('age');
                                    query_location = query_member.get('info');
                                }
                            }
                        }
                    }
                });

                // Write the common channels in the right bar
                $('#kiwi .right_bar .queries .' + panel.cid + ' .common_channels').append(common_channels.join(', '));

                // Set the gender avatar
                if(query_gender == 'M') {
                    avatar = "/assets/plugins/user-Male.png";
                    $('#kiwi .right_bar .queries .' + panel.cid + ' .query_nick_nickname').css('color', '#0066ff');
                    gender_text = text.gender_male;
                } else if(query_gender == 'F') {
                    avatar = "/assets/plugins/user-Female.png";
                    $('#kiwi .right_bar .queries .' + panel.cid + ' .query_nick_nickname').css('color', '#FF00FF');
                    gender_text = text.gender_female;
                } else {
                    avatar = "/assets/plugins/avatar-undefined.jpg"
                    $('#kiwi .right_bar .queries .' + panel.cid + ' .query_nick_nickname').css('color', '#000000');
                    gender_text = text.gender_undefined;
                }
                // Add the avatar
                if(avatar != '') {
                    $('#kiwi .queries .' + panel.cid + ' .query_avatar').append('<img src="' + avatar + '" width="160" height="160" />');
                }

                // Bind  button actions
                // Click on WHOIS button
                $('#kiwi .right_bar .queries .' + panel.cid + ' .query_whois').on('click', function () {
                    var net = kiwi.components.Network();
                    net.raw('WHOIS :' + query_nick);
                });
                
                // Click on Ignore button
                $('#kiwi .right_bar .queries .' + panel.cid + ' .query_ignore').on('click', function () {
                    var ignore_state = toggleIgnore(query_nick);
                    // If nick is ignored, switch the button text
                    if(ignore_state) {
                        $('#kiwi .right_bar .queries .' + panel.cid + ' .query_ignore').html('<i title="' + text.unignore + '" class="fa fa-minus-circle"></i>&nbsp;' + text.unignore);
                    } else {
                        $('#kiwi .right_bar .queries .' + panel.cid + ' .query_ignore').html('<i title="' + text.ignore + '" class="fa fa-minus-circle"></i>&nbsp;' + text.ignore);
                    }
                });

                // Add the gender
                $('#kiwi .right_bar .queries .' + panel.cid + ' .query_gender').text(gender_text);
                // If there is an gender and an age, seperate with a comma
                if(query_age != '' && gender_text != '') {
                    query_age = ', ' + query_age;
                }
                // Add the Age
                if(query_age != '') {
                    query_age = query_age + ' ' + text.years_old;
                }
                $('#kiwi .right_bar .queries .' + panel.cid + ' .query_age').text(query_age);
                // If there is an age and a location, seperate with a comma
                if(query_age != '' && query_location != '') {
                    query_location = ', ' + query_location;
                }
                // Add the Location
                $('#kiwi .right_bar .queries .' + panel.cid + ' .query_location').text(query_location);
            } else { // The query exists but is inactive
                // Hide all right_bars
                $('#kiwi .memberlists').children().removeClass('active');
                $('#kiwi .memberlists').hide();
                $('#kiwi .right-bar-content .queries .' + panel.cid).addClass('active');
            }

            // Tweak the right_bar visibility
            setTimeout(function () {
                if ($('#kiwi .right_bar').hasClass('disabled')) {
                    $('#kiwi .right_bar').removeClass('disabled');
                    $('#kiwi .memberlists').children().removeClass('active');
                    $('#kiwi .memberlists').hide();
                    $('#kiwi .right_bar .right-bar-content .channel_tools').hide();
                }
            }, 20);
        } else { // Maybe moving out of a query so hide them all
            $('#kiwi .right_bar .right-bar-content .channel_tools').show();
            $('#kiwi .memberlists').show();
        }
    });

    kiwi.events.on('panel:close', function(event, panel) {
        var panel = panel['panel'];
        if(panel.isQuery()) {
            $('#kiwi .right_bar .queries .' + panel.cid).remove();
        }
    });


    function toggleIgnore(nick) {
        var ignore_list = kiwi.connections.active_connection.get("ignore_list");
        var i = ignore_list.indexOf(nick);;

        if(i == -1) {
            ignore_list.push(nick);
            return true;
        } else {
            ignore_list.splice(i, 1);
            return false;
        }
    }

    function getIgnoreStatus(nick) {
        var ignore_list = kiwi.connections.active_connection.get("ignore_list");
        return ignore_list.indexOf(nick);
    }



        
    // bouton
    /*
    $(document).on("click", ".userbox .query", function () {
        console.log("on click pour ouvrir le pv");
        //fix bug
        $(".right_bar .right-bar-toggle-inner").trigger("click");
        if (kiwi.panels().active.isQuery()) {

            if ($(".right_bar_pv").length > 0) {
                $(".right_bar_pv").removeClass("disabled");
                $(".panels").css("right", $(".right_bar_pv").width());
            } else {
                $("#kiwi").prepend(html);
                $(".panels").css("right", $(".right_bar_pv").width());
            }
            ignoreornot();
        }
    });

    $(document).on("click", ".panellist li", function () {
        if (kiwi.panels().active.isQuery()) {
            console.log("cest un pv");
            //fix bug
            $(".right_bar .right-bar-toggle-inner").trigger("click");   

            if ($(".right_bar_pv").length > 0) {
                if(hide) {
                    $(".right_bar_pv .right-bar-toggle").show();
                }
                $(".right_bar_pv").removeClass("disabled");
                $(".panels").css("right", $(".right_bar_pv").width());
            } else {
                $("#kiwi").prepend(html);
                $(".panels").css("right", $(".right_bar_pv").width());
            }
            ignoreornot();
        } else {
            $(".memberlists_resize_handle").show();
            $(".right_bar_pv").addClass("disabled");
            if(hide) {
                $(".right_bar_pv .right-bar-toggle").hide();
            }
        }
    });*/


});

</script>

