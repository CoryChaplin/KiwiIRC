<!--
    Plugin by Webfit for KiwiIRC - http://www.webfit.fr - 07/2014
    Reworked by Cory Chaplin (elephantman@europnet.org) - http://www.europnet.org - 01/2015 
-->

<style>
    /*#kiwi .cred {
        color: #ff0000;
    }
    #kiwi .right_bar_query {
        background-color: #fff;
        border-left: 1px dashed #ccc;
        z-index: 10;
        bottom: 100px;
        overflow: visible;
        position: absolute;
        right: 0;
        top: 100px;
        width: 200px;
    }
    #kiwi .right_bar_query.disabled {
        width: 0;
    }*/
</style>

<script type="text/html" id="query_sidebar">
<div class="right_bar_query">
    <div class="right-bar-toggle" style="display: none;">
        <i class="fa fa-user"></i>
    </div>
    <div class="query-right-bar-content">
        <div class="query_nick"></div>
        <div class="query_tools">
            <button class="query_whois"><i title="<%= whois %>" class="fa fa-search"></i>&nbsp;<%= whois %></button><br />
            <button class="query_ignore"><i title="<%= ignore %>" class="fa fa-minus-circle"></i>&nbsp;<%= ignore %></button><br />
            <i title="<%= hide_sidebar %>" class="fa fa-angle-double-right right-bar-toggle-inner"></i>
        </div>
    </div>
</div>
</script>


<script>
kiwi.plugins.on('loaded', function() {
    var locale_strings,
        text;

    locale_strings = {
        'en': {
            "query_sidebar" : {
                "" : {
                    "domain" : "query_sidebar",
                    "lang" : "en"
                },
                "whois" : [ null, "User info" ],
                "ignore" : [ null, "Ignore user" ],
                "unignore" : [ null, "Stop ignoring" ],
                "common_channels" : [ null, "Channels in common" ],
                "hide_sidebar" : [ null, "Hide" ]
            }
        },
       'fr': {
            "query_sidebar" : {
                "" : {
                    "domain" : "query_sidebar",
                    "lang" : "fr"
                },
                "whois" : [ null, "Infos" ],
                "ignore" : [ null, "Ignorer" ],
                "unignore" : [ null, "Ne plus ignorer" ],
                "common_channels" : [ null, "Channels in common" ],
                "hide_sidebar" : [ null, "Masquer" ]
            }
        }
    }

    // Create a new JED instance
    this.locale = new Jed({
        "domain" : "query_sidebar",
        "missing_key_callback" : function(key) {
            console.error('Translation key missing: ' + key)
        },
        "locale_data" : locale_strings[kiwi.i18n._textdomain] || locale_strings['en']
    });

    // Set the locale strings
    text = {
        whois: this.locale.translate('whois').fetch(),
        ignore: this.locale.translate('ignore').fetch(),
        unignore: this.locale.translate('unignore').fetch(),
        common_channels: this.locale.translate('common_channels').fetch(),
        hide_sidebar: this.locale.translate('hide_sidebar').fetch()
    };


    kiwi.events.on('panel:change', function(event, panel) {
        var panel = panel['panel'];
        //console.log('pp', panel.model.get('name'));
        
        if(panel.model.view.model.isQuery()) {
            // Push the html with the locale strings
            var query_sidebar = $(_.template($('#query_sidebar').html().trim(), text));
            $('.right_bar').append(query_sidebar);
            $('.right_bar .query_nick').text(panel.model.get('name'));

            // Tweak the right_bar visibility
            setTimeout(function () {
                if ($('.right_bar').hasClass('disabled')) {
                    $('.right_bar').removeClass('disabled');
                    $('#kiwi .memberlists').children().removeClass('active');
                    $('.right-bar-content').hide();
                }
            }, 20);

            // Bind  button actions
            $('.right_bar .query_whois').on('click', function () {
                var net = kiwi.components.Network();
                net.raw('WHOIS :' + kiwi.panels().active.get("name"));
            });
            
            $('.right_bar .query_ignore').on('click', function () {
            });


        }
    });


    // This plugin is only valid for rich_nicklist contexts
    if(!kiwi.settings.get('rich_nicklist')) return;

    
    var View = Backbone.View.extend({
        events: {
        },


        initialize: function (options) {


        },

        render: function () {
            console.log('RENDER');
        },
        
        
        toggleIgnore: function () {
            
        },
        
        listCommonChannels: function () {
        
        }
    });
    console.log(kiwi);
    
    // bouton
    /*$(document).on("click",".pv_whois", function() {
        var net = kiwi.components.Network();
        net.raw('WHOIS :' +kiwi.panels().active.get("name"));
    });

    $(document).on("click",".pv_ignore", function() {
        var ignorelist_data = kiwi.components.DataStore.instance('kiwi.ignore_list');
        ignorelist_data.load();

        var ignorelist = ignorelist_data.get('ignore_list');

        var tab = kiwi.connections.active_connection.get("ignore_list");
        var i = tab.indexOf(kiwi.panels().active.get("name"));

        console.log("i = " + i);

        if(i == -1) {
            tab.push(kiwi.panels().active.get("name"));
            $(this).addClass("cred");
        } else {
            tab.splice(i,1);
            $(this).removeClass("cred");
        }
        kiwi.connections.active_connection.set("ignore_list",tab);

        ignorelist_data.set('ignore_list',tab);
        ignorelist_data.save();
    });


    // barre
    var html = '';

    $(document).on("click", ".part", function () {
        if (!kiwi.panels().active.isQuery()) {
            $(".right_bar_pv").addClass("disabled");
        }
    });

    $(document).on("click", ".right_bar_pv .right-bar-toggle", function () {
        $(".right_bar_pv").css("width", '');
        $(this).hide();
        $(".panels").css("right", $(".right_bar_pv").width());
        hide = false;
    });
    $(document).on("click", ".right_bar_pv .right-bar-toggle-inner", function () {
        $(".right_bar_pv").css("width", "0");
        $(".panels").css("right", $(".right_bar_pv").width());

        $(".right_bar_pv .right-bar-toggle").show();
        hide = true;
    });
    $(document).on("click", ".userbox .query", function () {
        console.log("on click pour ouvrir le pv");
        //fix bug
        $(".right_bar .right-bar-toggle-inner").trigger("click");
        if (kiwi.panels().active.isQuery()) {

            if ($(".right_bar_pv").length > 0) {
                $(".right_bar_pv").removeClass("disabled");
                $(".panels").css("right", $(".right_bar_pv").width());
            } else {
                $("#kiwi").prepend(html);
                $(".panels").css("right", $(".right_bar_pv").width());
            }
            ignoreornot();
        }
    });

    $(document).on("click", ".panellist li", function () {
        if (kiwi.panels().active.isQuery()) {
            console.log("cest un pv");
            //fix bug
            $(".right_bar .right-bar-toggle-inner").trigger("click");	

            if ($(".right_bar_pv").length > 0) {
                if(hide) {
                    $(".right_bar_pv .right-bar-toggle").show();
                }
                $(".right_bar_pv").removeClass("disabled");
                $(".panels").css("right", $(".right_bar_pv").width());
            } else {
                $("#kiwi").prepend(html);
                $(".panels").css("right", $(".right_bar_pv").width());
            }
            ignoreornot();
        } else {
            $(".memberlists_resize_handle").show();
            $(".right_bar_pv").addClass("disabled");
            if(hide) {
                $(".right_bar_pv .right-bar-toggle").hide();
            }
        }
    });*/



    function ignoreornot() {
        console.log(kiwi.panels().active.get('members'));

        var tab = kiwi.connections.active_connection.get("ignore_list");
        var i = tab.indexOf(kiwi.panels().active.get("name"));

        if(i == -1) {
            $(".pv_ignore").removeClass("cred");
        } else {
            $(".pv_ignore").addClass("cred");
        }
    }
});

//fix bug nicklist
var width;
var hide = false;
$(document).on("click", ".right_bar .right-bar-toggle", function() {
	if(parseInt(width) > 0 && width != null) {
        $(".right_bar").css("width",width);
        $(".memberlists_resize_handle").css("left",$("#kiwi").width() - parseInt(width) -10);
    } else {
        $(".right_bar").css("width",'');
    }
});
$(document).on("click", ".right_bar .right-bar-toggle-inner", function() {
	if($(".right_bar").hasClass("disabled")) {
		console.log($(".right_bar").css("width"));
		if(parseInt($(".right_bar").css("width")) > 0) {
			console.log("on set width");
			width = $(".right_bar").css("width");
		}
		
		$(".right_bar").css("width",'');
		console.log("width = " + width);			
	} else {
		if( parseInt(width) > 0 && width != null) {
			$(".right_bar").css("width",width);
		} else {
			$(".right_bar").css("width",'');
		}
	}
});
// fin fix
</script>

