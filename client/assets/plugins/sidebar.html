<!--
    Plugin by Cory Chaplin (elephantman@europnet.org) - http://www.europnet.org - 01/2015 
-->

<style>
    /*#kiwi .cred {
        color: #ff0000;
    }
    #kiwi .right_bar_query {
        background-color: #fff;
        border-left: 1px dashed #ccc;
        z-index: 10;
        bottom: 100px;
        overflow: visible;
        position: absolute;
        right: 0;
        top: 100px;
        width: 200px;
    }
    #kiwi .right_bar_query.disabled {
        width: 0;
    }*/
    #kiwi .right_bar .queries > div {
        display: none;
    }
    #kiwi .right_bar .queries > div.active {
        display: block;
    }
</style>

<script type="text/html" id="query_sidebar_container">
<div class="queries">
</div>
</script>
<script type="text/html" id="query_sidebar_content">
    <div class="<%= query_id %>">
        <div class="query_nick">
            <%= query_with %><br />
            <span class="query_nick_nickname"></span>
        </div>
        <div class="query_avatar"></div>
        <div class="query_age"></div>
        <div class="query_location"></div>
        <div class="common_channels">
            <span class="query_common_channels_title"><%= common_channels %></span><br />
        </div>        
        <div class="query_tools">
            <button class="query_whois"><i title="<%= whois %>" class="fa fa-search"></i>&nbsp;<%= whois %></button><br />
            <button class="query_ignore"><i title="<%= ignore %>" class="fa fa-minus-circle"></i>&nbsp;<%= ignore %></button><br />
            <i title="<%= hide_sidebar %>" class="fa fa-angle-double-right right-bar-toggle-inner"></i>
        </div>
    </div>
</script>


<script>
kiwi.plugins.on('loaded', function() {
    // This plugin is only valid for rich_nicklist contexts
    if(!kiwi.settings.get('rich_nicklist')) return;

    var locale_strings,
        text;

    locale_strings = {
        'en': {
            "query_sidebar" : {
                "" : {
                    "domain" : "query_sidebar",
                    "lang" : "en"
                },
                "whois" : [ null, "User info" ],
                "ignore" : [ null, "Ignore user" ],
                "unignore" : [ null, "Stop ignoring" ],
                "common_channels" : [ null, "Channels in common" ],
                "hide_sidebar" : [ null, "Hide" ],
                "query_with" : [ null, "Query with" ]
            }
        },
       'fr': {
            "query_sidebar" : {
                "" : {
                    "domain" : "query_sidebar",
                    "lang" : "fr"
                },
                "whois" : [ null, "Infos" ],
                "ignore" : [ null, "Ignorer" ],
                "unignore" : [ null, "Ne plus ignorer" ],
                "common_channels" : [ null, "Salons communs" ],
                "hide_sidebar" : [ null, "Masquer" ],
                "query_with" : [ null, "Dialogue priv√© avec" ]
            }
        }
    }

    // Create a new JED instance
    this.locale = new Jed({
        "domain" : "query_sidebar",
        "missing_key_callback" : function(key) {
            console.error('Translation key missing: ' + key)
        },
        "locale_data" : locale_strings[kiwi.i18n._textdomain] || locale_strings['en']
    });

    // Set the locale strings
    text = {
        whois: this.locale.translate('whois').fetch(),
        ignore: this.locale.translate('ignore').fetch(),
        unignore: this.locale.translate('unignore').fetch(),
        common_channels: this.locale.translate('common_channels').fetch(),
        hide_sidebar: this.locale.translate('hide_sidebar').fetch(),
        query_with: this.locale.translate('query_with').fetch()
    };


    kiwi.events.on('panel:active', function(event, panel) {
        var panel = panel['active'];

        // Hide all query rightbars
        $('#kiwi .right-bar-content .queries').children().removeClass('active');        
        
        if(panel.isQuery()) {
            // If this is the first query, create "queries" right_bar container
            if($('#kiwi .right-bar-content .queries') == undefined || $('#kiwi .right-bar-content .queries').length == 0) {
                var query_sidebar_container = $(_.template($('#query_sidebar_container').html().trim(), text));
                
                $('#kiwi .right_bar .right-bar-content').append(query_sidebar_container);
            }

            // If this query doesn't exist yet, we'll create the right_bar for it
            if($('#kiwi .right-bar-content .queries .' + panel.cid).length == 0) {
                text['query_id'] = panel.cid;

                // Push the html with the locale strings
                var query_sidebar_content = $(_.template($('#query_sidebar_content').html().trim(), text));
                var query_nick = panel.get('name'),
                    common_channels = [],
                    query_gender = '',
                    query_age = '',
                    query_location = '',
                    avatar = '';

                // Add the right_bar content
                $('#kiwi .right-bar-content .queries').append(query_sidebar_content);
                $('#kiwi .right_bar .queries .' + panel.cid + ' .query_nick .query_nick_nickname').text(query_nick);
                // Make the right_bar for this query visible
                $('#kiwi .right-bar-content .queries .' + panel.cid).addClass('active');


                // Run through all the open channels to find the ones in common with the current query user
                _.each(kiwi.connections.panels(), function(panel) {
                    if(panel.get('members') != undefined) {
                        var members = panel.get('members').nick_cache,
                            panel_name = panel.get('name');

                        // Check if the member is in the channel
                        for(member in members) {
                            var regexp = new RegExp(query_nick, 'i');
                            if(member.match(regexp)) {
                                common_channels.push(panel_name);

                                // Find ASL from the member we're opening a query with 
                                if(query_gender == '') {
                                    var query_member = members[member];

                                    query_gender = query_member.get('gender');
                                    query_age = query_member.get('age');
                                    query_location = query_member.get('location');
                                }
                            }
                        }
                    }
                });
                // Write the common channels in the right bar
                $('#kiwi .right_bar .queries .' + panel.cid + ' .common_channels').append(common_channels.join(', '));

                // Set the gender avatar
                if(query_gender == 'M') {
                    avatar = "http://www.chat-fr.org/components/com_community/assets/user-Male.png";
                } else if(query_gender == 'F') {
                    avatar = "http://www.chat-fr.org/components/com_community/assets/user-Female.png";
                } else {
                    avatar = "http://www.thechaplins.fr:7778/assets/plugins/avatar-undefined.jpg"
                }
                // Add the avatar
                if(avatar != '') {
                    $('#kiwi .queries .' + panel.cid + ' .query_avatar').append('<img src="' + avatar + '" width="160" height="160" />');
                }

                // Bind  button actions
                $('.right_bar .query_whois').on('click', function () {
                    var net = kiwi.components.Network();
                    net.raw('WHOIS :' + query_nick);
                });
                
                $('.right_bar .query_ignore').on('click', function () {
                });
            } else { // The query exists but is inactive
                // Hide all right_bars
                $('#kiwi .memberlists').children().removeClass('active');
                $('#kiwi .right-bar-content .queries .' + panel.cid).addClass('active');
            }

            // Tweak the right_bar visibility
            setTimeout(function () {
                if ($('.right_bar').hasClass('disabled')) {
                    $('.right_bar').removeClass('disabled');
                    $('#kiwi .memberlists').children().removeClass('active');
                    $('#kiwi .right_bar .right-bar-content .channel_tools').hide();
                }
            }, 20);
        } else { // Maybe moving out of a query so hide them all
            $('#kiwi .right_bar .right-bar-content .channel_tools').show();
        }
    });

kiwi.events.on('panel:close', function(event, panel) {
    var panel = panel['panel'];
    if(panel.isQuery()) {
        $('#kiwi .right_bar .queries .' + panel.cid).remove();
    }
});

        
    // bouton
    /*$(document).on("click",".pv_whois", function() {
        var net = kiwi.components.Network();
        net.raw('WHOIS :' +kiwi.panels().active.get("name"));
    });

    $(document).on("click",".pv_ignore", function() {
        var ignorelist_data = kiwi.components.DataStore.instance('kiwi.ignore_list');
        ignorelist_data.load();

        var ignorelist = ignorelist_data.get('ignore_list');

        var tab = kiwi.connections.active_connection.get("ignore_list");
        var i = tab.indexOf(kiwi.panels().active.get("name"));

        console.log("i = " + i);

        if(i == -1) {
            tab.push(kiwi.panels().active.get("name"));
            $(this).addClass("cred");
        } else {
            tab.splice(i,1);
            $(this).removeClass("cred");
        }
        kiwi.connections.active_connection.set("ignore_list",tab);

        ignorelist_data.set('ignore_list',tab);
        ignorelist_data.save();
    });


    // barre
    var html = '';

    $(document).on("click", ".part", function () {
        if (!kiwi.panels().active.isQuery()) {
            $(".right_bar_pv").addClass("disabled");
        }
    });

    $(document).on("click", ".right_bar_pv .right-bar-toggle", function () {
        $(".right_bar_pv").css("width", '');
        $(this).hide();
        $(".panels").css("right", $(".right_bar_pv").width());
        hide = false;
    });
    $(document).on("click", ".right_bar_pv .right-bar-toggle-inner", function () {
        $(".right_bar_pv").css("width", "0");
        $(".panels").css("right", $(".right_bar_pv").width());

        $(".right_bar_pv .right-bar-toggle").show();
        hide = true;
    });
    $(document).on("click", ".userbox .query", function () {
        console.log("on click pour ouvrir le pv");
        //fix bug
        $(".right_bar .right-bar-toggle-inner").trigger("click");
        if (kiwi.panels().active.isQuery()) {

            if ($(".right_bar_pv").length > 0) {
                $(".right_bar_pv").removeClass("disabled");
                $(".panels").css("right", $(".right_bar_pv").width());
            } else {
                $("#kiwi").prepend(html);
                $(".panels").css("right", $(".right_bar_pv").width());
            }
            ignoreornot();
        }
    });

    $(document).on("click", ".panellist li", function () {
        if (kiwi.panels().active.isQuery()) {
            console.log("cest un pv");
            //fix bug
            $(".right_bar .right-bar-toggle-inner").trigger("click");	

            if ($(".right_bar_pv").length > 0) {
                if(hide) {
                    $(".right_bar_pv .right-bar-toggle").show();
                }
                $(".right_bar_pv").removeClass("disabled");
                $(".panels").css("right", $(".right_bar_pv").width());
            } else {
                $("#kiwi").prepend(html);
                $(".panels").css("right", $(".right_bar_pv").width());
            }
            ignoreornot();
        } else {
            $(".memberlists_resize_handle").show();
            $(".right_bar_pv").addClass("disabled");
            if(hide) {
                $(".right_bar_pv .right-bar-toggle").hide();
            }
        }
    });*/



    function ignoreornot() {
        console.log(kiwi.panels().active.get('members'));

        var tab = kiwi.connections.active_connection.get("ignore_list");
        var i = tab.indexOf(kiwi.panels().active.get("name"));

        if(i == -1) {
            $(".pv_ignore").removeClass("cred");
        } else {
            $(".pv_ignore").addClass("cred");
        }
    }
});

//fix bug nicklist
var width;
var hide = false;
$(document).on("click", ".right_bar .right-bar-toggle", function() {
	if(parseInt(width) > 0 && width != null) {
        $(".right_bar").css("width",width);
        $(".memberlists_resize_handle").css("left",$("#kiwi").width() - parseInt(width) -10);
    } else {
        $(".right_bar").css("width",'');
    }
});
$(document).on("click", ".right_bar .right-bar-toggle-inner", function() {
	if($(".right_bar").hasClass("disabled")) {
		console.log($(".right_bar").css("width"));
		if(parseInt($(".right_bar").css("width")) > 0) {
			console.log("on set width");
			width = $(".right_bar").css("width");
		}
		
		$(".right_bar").css("width",'');
		console.log("width = " + width);			
	} else {
		if( parseInt(width) > 0 && width != null) {
			$(".right_bar").css("width",width);
		} else {
			$(".right_bar").css("width",'');
		}
	}
});
// fin fix
</script>

